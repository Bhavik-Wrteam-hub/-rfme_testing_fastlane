default_platform(:ios)

platform :ios do

  desc "Build, sign, and upload to TestFlight"
  lane :deploy do

    # ── 1. App Store Connect API Key ──────────────────────────
    #   This action stores the key in the lane context.
    #   build_app and upload_to_testflight automatically detect
    #   and use it — NO manual xcargs needed for authentication.
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_CONTENT"],
      is_key_content_base64: false,
      in_house: false
    )

    # ── 2. Build & sign ───────────────────────────────────────
    #   gym (build_app) automatically:
    #     • Writes the .p8 key to a temp file
    #     • Passes -authenticationKey* flags to BOTH archive & export
    #     • Passes -allowProvisioningUpdates
    #   We only need to specify build/export configuration.
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      output_directory: "../build/ios/ipa",
      output_name: "Runner.ipa",
      clean: false,
      export_options: {
        signingStyle: "automatic",
        teamID: "75X5SQS732",
        uploadSymbols: true,
      },
    )

    # ── 3. Upload to TestFlight ───────────────────────────────
    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: true,
      skip_submission: false,
    )

  end

end
