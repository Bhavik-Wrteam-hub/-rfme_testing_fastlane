default_platform(:ios)

platform :ios do

  desc "Build, sign, and upload to TestFlight"
  lane :deploy do

    # 1. Set up App Store Connect API Key (used by upload_to_testflight)
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_CONTENT"],
      is_key_content_base64: false,
      in_house: false
    )

    # 2. Write the API key to disk for xcodebuild authentication
    api_key_path = "/tmp/AuthKey_#{ENV['APP_STORE_CONNECT_KEY_ID']}.p8"
    key_content = ENV["APP_STORE_CONNECT_API_KEY_CONTENT"]
    # Handle escaped newlines that GitHub secrets may introduce
    key_content = key_content.gsub("\\n", "\n") if key_content.include?("\\n")
    File.write(api_key_path, key_content)

    # 3. Shared xcodebuild authentication arguments
    #    IMPORTANT: No quotes around values — fastlane handles escaping.
    xcode_auth = "-allowProvisioningUpdates " \
                 "-authenticationKeyPath #{api_key_path} " \
                 "-authenticationKeyID #{ENV['APP_STORE_CONNECT_KEY_ID']} " \
                 "-authenticationKeyIssuerID #{ENV['APP_STORE_CONNECT_ISSUER_ID']}"

    # 4. Build & sign (cloud-managed automatic signing via API key)
    #    - xcargs:        auth flags for the ARCHIVE step
    #    - export_xcargs: auth flags for the EXPORT step (critical!)
    #    - export_options: signing config for the export plist
    #      NOTE: Do NOT include provisioningProfiles when using
    #            signingStyle "automatic" — Xcode resolves profiles
    #            automatically via the API key + allowProvisioningUpdates.
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      output_directory: "../build/ios/ipa",
      output_name: "Runner.ipa",
      clean: false,
      xcargs: "#{xcode_auth} -allowProvisioningDeviceRegistration",
      export_xcargs: xcode_auth,
      export_options: {
        signingStyle: "automatic",
        teamID: "75X5SQS732",
        uploadSymbols: true,
      },
    )

    # 5. Upload to TestFlight
    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: true,
      skip_submission: false,
    )

    # 6. Clean up temp files
    File.delete(api_key_path) if File.exist?(api_key_path)

  end

end
