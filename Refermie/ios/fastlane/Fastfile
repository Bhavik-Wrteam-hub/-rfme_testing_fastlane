default_platform(:ios)

platform :ios do

  desc "Build, sign, and upload to TestFlight"
  lane :deploy do

    # 1. Set up App Store Connect API Key
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_CONTENT"],
      is_key_content_base64: false,
      in_house: false
    )

    # 2. Write the API key to a temp file for xcodebuild authentication
    api_key_path = "/tmp/AuthKey_#{ENV['APP_STORE_CONNECT_KEY_ID']}.p8"
    key_content = ENV["APP_STORE_CONNECT_API_KEY_CONTENT"]
    # Handle escaped newlines that GitHub secrets may introduce
    key_content = key_content.gsub("\\n", "\n") if key_content.include?("\\n")
    File.write(api_key_path, key_content)

    # 3. Create ExportOptions.plist file
    #    Passing a plist FILE (not a hash) bypasses fastlane's local
    #    provisioning profile detection. This lets xcodebuild resolve
    #    signing entirely via cloud-managed certificates + API key auth.
    export_plist_path = "/tmp/ExportOptions.plist"
    File.write(export_plist_path, <<~PLIST)
      <?xml version="1.0" encoding="UTF-8"?>
      <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
      <plist version="1.0">
      <dict>
        <key>method</key>
        <string>app-store</string>
        <key>signingStyle</key>
        <string>automatic</string>
        <key>teamID</key>
        <string>75X5SQS732</string>
        <key>uploadSymbols</key>
        <true/>
      </dict>
      </plist>
    PLIST

    # 4. Build & sign (cloud-managed signing via API key)
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      output_directory: "../build/ios/ipa",
      output_name: "Runner.ipa",
      clean: false,
      xcargs: "-allowProvisioningUpdates -allowProvisioningDeviceRegistration " \
              "-authenticationKeyPath '#{api_key_path}' " \
              "-authenticationKeyID '#{ENV['APP_STORE_CONNECT_KEY_ID']}' " \
              "-authenticationKeyIssuerID '#{ENV['APP_STORE_CONNECT_ISSUER_ID']}'",
      export_xcargs: "-allowProvisioningUpdates " \
                     "-authenticationKeyPath '#{api_key_path}' " \
                     "-authenticationKeyID '#{ENV['APP_STORE_CONNECT_KEY_ID']}' " \
                     "-authenticationKeyIssuerID '#{ENV['APP_STORE_CONNECT_ISSUER_ID']}'",
      export_options: export_plist_path,
    )

    # 5. Upload to TestFlight
    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: true,
      skip_submission: false,
    )

    # 6. Clean up temp files
    File.delete(api_key_path) if File.exist?(api_key_path)
    File.delete(export_plist_path) if File.exist?(export_plist_path)

  end

end
